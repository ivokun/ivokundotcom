name: CMS PR Checks

on:
  pull_request:
    branches: [main]
    paths:
      - 'cms/**'
      - '.github/workflows/cms-pr-checks.yml'
  push:
    branches: [main]
    paths:
      - 'cms/**'
      - '.github/workflows/cms-pr-checks.yml'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cms

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.38'

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Run ESLint
        run: bun run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cms

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.38'

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Run TypeScript type check
        run: bun run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cms

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.38'

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Run tests
        run: bun test

  build-spa:
    name: Build SPA
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cms

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.38'

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Build admin SPA
        run: bun run build:spa

  build-binary:
    name: Build Binary
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cms

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.38'

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: .

      - name: Compile binary
        run: |
          mkdir -p dist
          bun build src/server.ts \
            --compile \
            --target=bun-linux-x64 \
            --outfile dist/cms \
            --minify \
            --sourcemap=linked \
            --external @effect/cluster \
            --external sharp

  sanity-check:
    name: Sanity Check
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build-spa, build-binary]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Typecheck: ${{ needs.typecheck.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Build SPA: ${{ needs.build-spa.result }}"
          echo "Build Binary: ${{ needs.build-binary.result }}"
          
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build-spa.result }}" != "success" ]] || \
             [[ "${{ needs.build-binary.result }}" != "success" ]]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed"
